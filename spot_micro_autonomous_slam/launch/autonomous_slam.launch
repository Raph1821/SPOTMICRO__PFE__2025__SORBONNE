<?xml version="1.0"?>
<launch>
    <!-- Autonomous SLAM Launch File
         
         This launch file starts the complete autonomous SLAM and exploration system:
         1. Motion control and servo interface
         2. Lidar driver
         3. Hector SLAM for mapping
         4. Move Base navigation stack
         5. Autonomous frontier explorer
         6. Map saver for storing results
         
         Arguments:
         - use_pybullet: Use PyBullet simulation (default: false for real robot)
         - rviz: Launch RViz visualization (default: true)
         - debug_mode: Enable debug output (default: false)
         - auto_explore: Start exploration automatically (default: false)
         - map_save_dir: Directory to save maps (default: ~/spot_micro_maps)
    -->
    
    <!-- Arguments -->
    <arg name="use_pybullet" default="false"/>
    <arg name="rviz" default="true"/>  <!-- Changed from use_rviz to rviz for consistency -->
    <arg name="debug_mode" default="false"/>
    <arg name="auto_explore" default="false"/>
    <arg name="map_save_dir" default="$(env HOME)/spot_micro_maps"/>
    <arg name="rviz_config" default="$(find spot_micro_rviz)/rviz/spot_micro_slam.rviz"/>
    
    <!-- ====== PyBullet Simulation (Optional) ====== -->
    <group if="$(arg use_pybullet)">
        <include file="$(find spot_micro_pybullet)/launch/pybullet_simulation.launch">
            <arg name="use_gui" value="true"/>
            <arg name="rviz" value="false"/>  <!-- We launch rviz separately -->
            <arg name="slam" value="true"/>
            <arg name="obstacles" value="true"/>
        </include>
    </group>
    
    <!-- ====== Real Robot (Default) ====== -->
    <!-- Motion Control, Lidar, and SLAM all included in motion_control_and_hector_slam.launch -->
    <group unless="$(arg use_pybullet)">
        <!-- SLAM Mapping with Motion Control and Lidar (Hector SLAM) -->
        <include file="$(find spot_micro_launch)/launch/motion_control_and_hector_slam.launch">
            <arg name="run_post_proc" value="false"/>
        </include>
    </group>
    
    <!-- ====== Odometry Publisher ====== -->
    <!-- Publishes /odom topic from TF for move_base -->
    <node name="odom_publisher" pkg="spot_micro_autonomous_slam" type="odom_publisher.py" output="screen"/>
    
    <!-- ====== Navigation Stack (Move Base) ====== -->
    <include file="$(find spot_micro_autonomous_slam)/launch/move_base.launch"/>
    
    <!-- ====== Autonomous Explorer Node ====== -->
    <node name="autonomous_explorer" pkg="spot_micro_autonomous_slam" type="autonomous_explorer.py" output="screen">
        <param name="exploration_mode" value="frontier"/>
        <param name="goal_tolerance" value="0.5"/>
        <param name="frontier_threshold" value="20"/>
        <param name="min_frontier_distance" value="0.3"/>
        <param name="max_frontier_distance" value="5.0"/>
        <param name="exploration_timeout" value="600.0"/>  <!-- 10 minutes -->
        <param name="enable_exploration" value="$(arg auto_explore)"/>
    </node>
    
    <!-- ====== Map Saver ====== -->
    <node name="map_saver" pkg="spot_micro_autonomous_slam" type="map_saver.py" output="screen">
        <param name="map_save_dir" value="$(arg map_save_dir)"/>
        <param name="save_interval" value="120.0"/>  <!-- Save every 2 minutes -->
        <param name="auto_save" value="true"/>
    </node>
    
    <!-- ====== RViz Visualization ====== -->
    <group if="$(arg rviz)">
        <node name="rviz" pkg="rviz" type="rviz" args="-d $(arg rviz_config)" output="screen"/>
    </group>
    
    <!-- ====== Frontier Exploration Client (Optional Alternative) ====== -->
    <!-- Uncomment to use frontier_exploration package instead of autonomous_explorer
    <node name="frontier_exploration_client" pkg="spot_micro_autonomous_slam" type="frontier_exploration_client.py" output="screen">
        <param name="enable_frontier_server" value="true"/>
    </node>
    -->

</launch>
